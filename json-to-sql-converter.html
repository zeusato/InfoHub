<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InfoHub Multi-File SQL Converter</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .upload-zones {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .upload-zone {
      border: 3px dashed #667eea;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9ff;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .upload-zone:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .upload-zone.drag-over {
      border-color: #764ba2;
      background: #e8eaff;
      transform: scale(1.02);
    }

    .upload-zone.uploaded {
      border-color: #28a745;
      background: #d4edda;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .upload-zone h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #667eea;
    }

    .upload-zone p {
      font-size: 12px;
      color: #666;
    }

    .file-input {
      display: none;
    }

    .file-name {
      margin-top: 10px;
      font-size: 12px;
      color: #28a745;
      font-weight: 600;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }

    .alert-info {
      background: #e7f3ff;
      border-color: #2196f3;
      color: #1976d2;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .output-section {
      display: none;
      margin-top: 30px;
      padding-top: 30px;
      border-top: 2px solid #eee;
    }

    .output-section.visible {
      display: block;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.9;
      text-transform: uppercase;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #eee;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .sql-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      position: relative;
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }

    .copy-btn:hover {
      background: #218838;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üîÑ InfoHub Multi-File SQL Converter</h1>
      <p>Chuy·ªÉn ƒë·ªïi Articles, Menu, v√† FAQ sang SQL cho Supabase</p>
    </div>

    <div class="content">
      <div class="alert alert-info">
        <strong>üìÅ Upload c√°c file (t√πy ch·ªçn):</strong><br>
        1. <code>src/data/leafContent.json</code> ‚Üí Articles<br>
        2. <code>src/lib/menuData.ts</code> ‚Üí Menu Items<br>
        3. <code>public/faqs/*.json</code> ‚Üí FAQ Items (c√≥ th·ªÉ upload nhi·ªÅu files)
      </div>

      <div class="upload-zones">
        <div class="upload-zone" id="articlesZone">
          <div class="upload-icon">üìÑ</div>
          <h3>leafContent.json</h3>
          <p>Articles data</p>
          <button class="btn" onclick="document.getElementById('articlesInput').click()"
            style="padding: 8px 20px; font-size: 14px; margin-top: 10px;">Ch·ªçn file</button>
          <input type="file" id="articlesInput" class="file-input" accept=".json">
          <div class="file-name" id="articlesName"></div>
        </div>

        <div class="upload-zone" id="menuZone">
          <div class="upload-icon">üìã</div>
          <h3>menuData.ts</h3>
          <p>Menu structure</p>
          <button class="btn" onclick="document.getElementById('menuInput').click()"
            style="padding: 8px 20px; font-size: 14px; margin-top: 10px;">Ch·ªçn file</button>
          <input type="file" id="menuInput" class="file-input" accept=".ts">
          <div class="file-name" id="menuName"></div>
        </div>

        <div class="upload-zone" id="faqZone">
          <div class="upload-icon">‚ùì</div>
          <h3>FAQ Files</h3>
          <p>faq-*.json (nhi·ªÅu files)</p>
          <button class="btn" onclick="document.getElementById('faqInput').click()"
            style="padding: 8px 20px; font-size: 14px; margin-top: 10px;">Ch·ªçn files</button>
          <input type="file" id="faqInput" class="file-input" accept=".json" multiple>
          <div class="file-name" id="faqName"></div>
        </div>
      </div>

      <div style="text-align: center; margin: 20px 0;">
        <button class="btn btn-success" id="generateBtn" onclick="generateAllSQL()" disabled>
          ‚ö° Generate SQL
        </button>
      </div>

      <div class="output-section" id="outputSection">
        <h2 style="margin-bottom: 20px; color: #667eea;">üìä Generated SQL</h2>

        <div class="stats" id="stats"></div>

        <div class="tabs">
          <button class="tab active" onclick="switchTab('full')">Full SQL</button>
          <button class="tab" onclick="switchTab('articles')">Articles</button>
          <button class="tab" onclick="switchTab('menu')">Menu</button>
          <button class="tab" onclick="switchTab('faq')">FAQ</button>
        </div>

        <div class="tab-content active" id="fullTab">
          <div class="sql-output">
            <button class="copy-btn" onclick="copyToClipboard('fullSQL')">üìã Copy</button>
            <pre id="fullSQL"></pre>
          </div>
        </div>

        <div class="tab-content" id="articlesTab">
          <div class="sql-output">
            <button class="copy-btn" onclick="copyToClipboard('articlesSQL')">üìã Copy</button>
            <pre id="articlesSQL"></pre>
          </div>
        </div>

        <div class="tab-content" id="menuTab">
          <div class="sql-output">
            <button class="copy-btn" onclick="copyToClipboard('menuSQL')">üìã Copy</button>
            <pre id="menuSQL"></pre>
          </div>
        </div>

        <div class="tab-content" id="faqTab">
          <div class="sql-output">
            <button class="copy-btn" onclick="copyToClipboard('faqSQL')">üìã Copy</button>
            <pre id="faqSQL"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const state = {
      articlesData: null,
      menuData: null,
      faqData: []
    };

    ['articles', 'menu', 'faq'].forEach(type => {
      const zone = document.getElementById(type + 'Zone');
      const input = document.getElementById(type + 'Input');
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
      zone.addEventListener('drop', e => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        handleFiles(type, type === 'faq' ? e.dataTransfer.files : [e.dataTransfer.files[0]]);
      });
      input.addEventListener('change', e => handleFiles(type, e.target.files));
    });

    function handleFiles(type, files) {
      if (!files.length) return;

      if (type === 'articles') {
        const file = files[0];
        if (!file.name.endsWith('.json')) return alert('Vui l√≤ng ch·ªçn file JSON!');
        readFile(file, data => {
          state.articlesData = JSON.parse(data);
          markUploaded('articles', file.name);
        });
      } else if (type === 'menu') {
        const file = files[0];
        if (!file.name.endsWith('.ts')) return alert('Vui l√≤ng ch·ªçn file .ts!');
        readFile(file, data => {
          state.menuData = parseMenuTS(data);
          markUploaded('menu', file.name);
        });
      } else if (type === 'faq') {
        state.faqData = [];
        let loaded = 0;
        Array.from(files).forEach(file => {
          if (!file.name.endsWith('.json')) return;
          readFile(file, data => {
            const faqData = JSON.parse(data);
            const category = file.name.replace('.json', '');
            state.faqData.push({ category, data: faqData });
            if (++loaded === files.length) markUploaded('faq', `${files.length} file(s)`);
          });
        });
      }
    }

    function readFile(file, callback) {
      const reader = new FileReader();
      reader.onload = e => callback(e.target.result);
      reader.readAsText(file);
    }

    function markUploaded(type, fileName) {
      document.getElementById(type + 'Zone').classList.add('uploaded');
      document.getElementById(type + 'Name').textContent = '‚úÖ ' + fileName;
      document.getElementById('generateBtn').disabled = !state.articlesData && !state.menuData && !state.faqData.length;
    }

    function parseMenuTS(tsContent) {
      const match = tsContent.match(/export const MENU: MenuNode\[\] = (\[[\s\S]*\])/);
      if (!match) return alert('Kh√¥ng t√¨m th·∫•y MENU array!'), null;
      try {
        return JSON.parse(match[1].replace(/'/g, '"').replace(/(\w+):/g, '"$1":').replace(/,(\\s*[}\]])/g, '$1'));
      } catch (e) {
        alert('L·ªói parse: ' + e.message);
        return null;
      }
    }

    function escapeSQL(str) {
      return !str ? 'NULL' : "'" + str.replace(/'/g, "''").replace(/\\/g, '\\\\') + "'";
    }

    function generateAllSQL() {
      const articlesSQL = state.articlesData ? generateArticlesSQL() : '-- No articles data uploaded';
      const menuSQL = state.menuData ? generateMenuSQL() : '-- No menu data uploaded';
      const faqSQL = state.faqData.length ? generateFAQSQL() : '-- No FAQ data uploaded';
      const fullSQL = articlesSQL + '\n\n' + menuSQL + '\n\n' + faqSQL;

      document.getElementById('articlesSQL').textContent = articlesSQL;
      document.getElementById('menuSQL').textContent = menuSQL;
      document.getElementById('faqSQL').textContent = faqSQL;
      document.getElementById('fullSQL').textContent = fullSQL;

      const articleCount = state.articlesData ? Object.keys(state.articlesData).length : 0;
      const menuCount = state.menuData ? countMenuItems(state.menuData) : 0;
      const faqCount = state.faqData.reduce((sum, f) => sum + f.data.faqs.length, 0);

      document.getElementById('stats').innerHTML = `
        <div class="stat-card"><div class="stat-number">${articleCount}</div><div class="stat-label">Articles</div></div>
        <div class="stat-card"><div class="stat-number">${menuCount}</div><div class="stat-label">Menu Items</div></div>
        <div class="stat-card"><div class="stat-number">${faqCount}</div><div class="stat-label">FAQ Items</div></div>
        <div class="stat-card"><div class="stat-number">${(new Blob([fullSQL]).size / 1024).toFixed(2)} KB</div><div class="stat-label">Size</div></div>
      `;
      document.getElementById('outputSection').classList.add('visible');
    }

    function generateArticlesSQL() {
      const articles = [];
      for (const [path, article] of Object.entries(state.articlesData)) {
        const contentJSON = article.content ? JSON.stringify(article.content).replace(/'/g, "''") : null;
        const galleryArray = article.gallery?.length ? "ARRAY[" + article.gallery.map(g => escapeSQL(g)).join(", ") + "]" : 'ARRAY[]::text[]';
        articles.push(`  (${escapeSQL(path)}, ${escapeSQL(article.title)}, ${escapeSQL(article.subtitle)}, ${escapeSQL(article.renderType || 'template')}, ${escapeSQL(article.templateKey)}, ${escapeSQL(article.bannerImg)}, ${contentJSON ? "'" + contentJSON + "'::jsonb" : 'NULL'}, ${escapeSQL(article.contentHtml)}, ${escapeSQL(article.endingNote)}, ${galleryArray}, ${escapeSQL(article.faqJsonPath)})`);
      }
      return `-- Articles Migration (${articles.length} articles)\nINSERT INTO articles (path, title, subtitle, render_type, template_key, banner_img, content, content_html, ending_note, gallery, faq_json_path)\nVALUES\n${articles.join(',\n')}\nON CONFLICT (path) DO UPDATE SET title = EXCLUDED.title, subtitle = EXCLUDED.subtitle, content = EXCLUDED.content, updated_at = NOW();`;
    }

    function generateMenuSQL() {
      const items = [];
      let orderIndex = 0;
      const uuidMap = new Map();

      // Simple UUID generator
      function uuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random() * 16 | 0;
          return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
      }

      function traverse(nodes, parentUuid, level) {
        nodes.forEach(node => {
          orderIndex++;
          const nodeUuid = uuid();
          uuidMap.set(node.id, nodeUuid);

          items.push({
            uuid: nodeUuid,
            label: node.label,
            path: node.path || null,
            parent_id: parentUuid,
            orderIndex,
            level
          });

          if (node.children?.length) {
            traverse(node.children, nodeUuid, level + 1);
          }
        });
      }

      traverse(state.menuData, null, 1);

      const insertStatements = items.map(item =>
        `  ('${item.uuid}', ${escapeSQL(item.label)}, ${escapeSQL(item.path)}, ${item.parent_id ? `'${item.parent_id}'` : 'NULL'}, ${item.orderIndex}, ${item.level}, true)`
      ).join(',\n');

      return `-- Menu Items Migration (${items.length} items)\nDELETE FROM menu_items;\n\nINSERT INTO menu_items (id, label, path, parent_id, order_index, level, active)\nVALUES\n${insertStatements};`;
    }

    function countMenuItems(nodes) {
      let count = 0;
      function traverse(items) { items.forEach(item => { count++; if (item.children) traverse(item.children); }); }
      traverse(nodes);
      return count;
    }

    function generateFAQSQL() {
      const items = [];
      let orderIndex = 0;
      state.faqData.forEach(({ category, data }) => {
        data.faqs.forEach(faq => {
          orderIndex++;
          items.push(`  (${escapeSQL(category)}, ${escapeSQL(faq.question)}, ${escapeSQL(faq.answer)}, ${faq.qNo || orderIndex})`);
        });
      });
      return `-- FAQ Items Migration (${items.length} items)\nINSERT INTO faq_items (category, question, answer, order_index)\nVALUES\n${items.join(',\n')}\nON CONFLICT DO NOTHING;`;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function copyToClipboard(elementId) {
      navigator.clipboard.writeText(document.getElementById(elementId).textContent).then(() => {
        const btn = event.target;
        const orig = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => btn.textContent = orig, 2000);
      });
    }
  </script>
</body>

</html>